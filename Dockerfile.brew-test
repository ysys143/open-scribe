# Test Homebrew installation on Linux using Linuxbrew
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV LANG=C.UTF-8
ENV LC_ALL=C.UTF-8

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    procps \
    file \
    && rm -rf /var/lib/apt/lists/*

# Create test user (homebrew can't run as root)
RUN useradd -m -s /bin/bash brew-user

# Install Linuxbrew as brew-user
USER brew-user
WORKDIR /home/brew-user

RUN curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | bash

# Add Homebrew to PATH
ENV PATH="/home/brew-user/.local/bin:$PATH"

# Clone current repository to simulate tap
RUN git clone https://github.com/jaesolshin/open-scribe.git /tmp/open-scribe-source

# Create mock tap repository structure
RUN mkdir -p /tmp/homebrew-open-scribe/Formula && \
    cp /tmp/open-scribe-source/Formula/open-scribe.rb /tmp/homebrew-open-scribe/Formula/

# Test: Add tap and install
RUN brew tap jaesolshin/homebrew-open-scribe /tmp/homebrew-open-scribe

# Show available formula
RUN brew search open-scribe || true

# Install open-scribe (this will build from source)
RUN brew install jaesolshin/homebrew-open-scribe/open-scribe

# Verify installation
RUN which scribe && scribe --help

# Test: Check .env creation
RUN echo "Test OpenAI key setup" && \
    echo "sk-test-key-12345" | scribe "https://www.youtube.com/watch?v=dQw4w9WgXcQ" 2>&1 | head -20 || true

RUN ls -la ~/.open-scribe/.env && cat ~/.open-scribe/.env

CMD ["/bin/bash"]
